{"version":3,"file":"urql-storage-rn.min.mjs","sources":["../src/makeAsyncStorage.ts"],"sourcesContent":["import type { StorageAdapter } from '@urql/exchange-graphcache';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport NetInfo from '@react-native-community/netinfo';\n\nexport interface StorageOptions {\n  /** Name of the `AsyncStorage` key that’s used for persisted data.\n   * @defaultValue `'graphcache-data'`\n   */\n  dataKey?: string;\n  /** Name of the `AsyncStorage` key that’s used for persisted metadata.\n   * @defaultValue `'graphcache-metadata'`\n   */\n  metadataKey?: string;\n  /** Maximum age of cache entries (in days) after which data is discarded.\n   * @defaultValue `7` days\n   */\n  maxAge?: number;\n}\n\nconst parseData = (persistedData: any, fallback: any) => {\n  try {\n    if (persistedData) {\n      return JSON.parse(persistedData);\n    }\n  } catch (_err) {}\n\n  return fallback;\n};\n\nlet disconnect;\n\n/** React Native storage adapter persisting to `AsyncStorage`. */\nexport interface DefaultAsyncStorage extends StorageAdapter {\n  /** Clears the entire `AsyncStorage`. */\n  clear(): Promise<any>;\n}\n\n/** Creates a {@link StorageAdapter} which uses React Native’s `AsyncStorage`.\n *\n * @param opts - A {@link StorageOptions} configuration object.\n * @returns the created {@link DefaultAsyncStorage} adapter.\n *\n * @remarks\n * `makeAsyncStorage` creates a storage adapter for React Native,\n * which persisted to `AsyncStorage` via the `@react-native-async-storage/async-storage`\n * package.\n *\n * Note: We have no data on stability of this storage and our Offline Support\n * for large APIs or longterm use. Proceed with caution.\n */\nexport const makeAsyncStorage: (\n  ops?: StorageOptions\n) => DefaultAsyncStorage = ({\n  dataKey = 'graphcache-data',\n  metadataKey = 'graphcache-metadata',\n  maxAge = 7,\n} = {}) => {\n  const todayDayStamp = Math.floor(\n    new Date().valueOf() / (1000 * 60 * 60 * 24)\n  );\n  let allData = {};\n\n  return {\n    readData: async () => {\n      if (!Object.keys(allData).length) {\n        let persistedData: string | null = null;\n        try {\n          persistedData = await AsyncStorage.getItem(dataKey);\n        } catch (_err) {}\n        const parsed = parseData(persistedData, {});\n\n        Object.assign(allData, parsed);\n      }\n\n      // clean up old data\n      let syncNeeded = false;\n      Object.keys(allData).forEach(dayStamp => {\n        if (todayDayStamp - Number(dayStamp) > maxAge) {\n          syncNeeded = true;\n          delete allData[dayStamp];\n        }\n      });\n\n      if (syncNeeded) {\n        try {\n          await AsyncStorage.setItem(dataKey, JSON.stringify(allData));\n        } catch (_err) {}\n      }\n\n      return Object.assign(\n        {},\n        ...Object.keys(allData).map(key => allData[key])\n      );\n    },\n\n    writeData: async delta => {\n      if (!Object.keys(allData).length) {\n        let persistedData: string | null = null;\n        try {\n          persistedData = await AsyncStorage.getItem(dataKey);\n        } catch (_err) {}\n        const parsed = parseData(persistedData, {});\n        Object.assign(allData, parsed);\n      }\n\n      const deletedKeys = {};\n      Object.keys(delta).forEach(key => {\n        if (delta[key] === undefined) {\n          deletedKeys[key] = undefined;\n        }\n      });\n\n      for (const key in allData) {\n        allData[key] = Object.assign(allData[key], deletedKeys);\n      }\n\n      allData[todayDayStamp] = Object.assign(\n        allData[todayDayStamp] || {},\n        delta\n      );\n\n      try {\n        await AsyncStorage.setItem(dataKey, JSON.stringify(allData));\n      } catch (_err) {}\n    },\n\n    writeMetadata: async data => {\n      try {\n        await AsyncStorage.setItem(metadataKey, JSON.stringify(data));\n      } catch (_err) {}\n    },\n\n    readMetadata: async () => {\n      let persistedData: string | null = null;\n      try {\n        persistedData = await AsyncStorage.getItem(metadataKey);\n      } catch (_err) {}\n      return parseData(persistedData, []);\n    },\n\n    onOnline: cb => {\n      if (disconnect) {\n        disconnect();\n        disconnect = undefined;\n      }\n\n      disconnect = NetInfo.addEventListener(({ isConnected }) => {\n        if (isConnected) {\n          cb();\n        }\n      });\n    },\n\n    clear: async () => {\n      try {\n        allData = {};\n        await AsyncStorage.removeItem(dataKey);\n        await AsyncStorage.removeItem(metadataKey);\n      } catch (_err) {}\n    },\n  };\n};\n"],"names":["disconnect","parseData","persistedData","fallback","JSON","parse","_err","makeAsyncStorage","dataKey","metadataKey","maxAge","todayDayStamp","Math","floor","Date","valueOf","allData","readData","async","Object","keys","length","AsyncStorage","getItem","parsed","assign","syncNeeded","forEach","dayStamp","Number","setItem","stringify","map","key","writeData","deletedKeys","delta","undefined","writeMetadata","data","readMetadata","onOnline","cb","NetInfo","addEventListener","isConnected","clear","removeItem"],"mappings":"wGAmBA,IAUIA,EAVEC,EAAYA,CAACC,EAAoBC,KACrC,IACE,GAAID,EACF,OAAOE,KAAKC,MAAMH,EAEtB,CAAE,MAAOI,GAAO,CAEhB,OAAOH,CAAQ,EAwBJI,EAEcA,EACzBC,UAAU,kBACVC,cAAc,sBACdC,SAAS,GACP,MACF,IAAMC,EAAgBC,KAAKC,OACzB,IAAIC,MAAOC,UAAS,OAElBC,EAAU,CAAA,EAEd,MAAO,CACLC,SAAUC,UACR,IAAKC,OAAOC,KAAKJ,GAASK,OAAQ,CAChC,IAAInB,EAA+B,KACnC,IACEA,QAAsBoB,EAAaC,QAAQf,EAC7C,CAAE,MAAOF,GAAO,CAChB,IAAMkB,EAASvB,EAAUC,EAAe,CAAE,GAE1CiB,OAAOM,OAAOT,EAASQ,EACzB,CAGA,IAAIE,GAAa,EAQjB,GAPAP,OAAOC,KAAKJ,GAASW,SAAQC,IACvBjB,EAAgBkB,OAAOD,GAAYlB,IACrCgB,GAAa,SACNV,EAAQY,GACjB,IAGEF,EACF,UACQJ,EAAaQ,QAAQtB,EAASJ,KAAK2B,UAAUf,GACrD,CAAE,MAAOV,GAAO,CAGlB,OAAOa,OAAOM,OACZ,MACGN,OAAOC,KAAKJ,GAASgB,KAAIC,GAAOjB,EAAQiB,KAC5C,EAGHC,UAAWhB,UACT,IAAKC,OAAOC,KAAKJ,GAASK,OAAQ,CAChC,IAAInB,EAA+B,KACnC,IACEA,QAAsBoB,EAAaC,QAAQf,EAC7C,CAAE,MAAOF,GAAO,CAChB,IAAMkB,EAASvB,EAAUC,EAAe,CAAE,GAC1CiB,OAAOM,OAAOT,EAASQ,EACzB,CAEA,IAAMW,EAAc,CAAA,EAOpB,IAAK,IAAMF,KANXd,OAAOC,KAAKgB,GAAOT,SAAQM,SACNI,IAAfD,EAAMH,KACRE,EAAYF,QAAOI,EACrB,IAGgBrB,EAChBA,EAAQiB,GAAOd,OAAOM,OAAOT,EAAQiB,GAAME,GAG7CnB,EAAQL,GAAiBQ,OAAOM,OAC9BT,EAAQL,IAAkB,GAC1ByB,GAGF,UACQd,EAAaQ,QAAQtB,EAASJ,KAAK2B,UAAUf,GACrD,CAAE,MAAOV,GAAO,GAGlBgC,cAAepB,UACb,UACQI,EAAaQ,QAAQrB,EAAaL,KAAK2B,UAAUQ,GACzD,CAAE,MAAOjC,GAAO,GAGlBkC,aAActB,UACZ,IAAIhB,EAA+B,KACnC,IACEA,QAAsBoB,EAAaC,QAAQd,EAC7C,CAAE,MAAOH,GAAO,CAChB,OAAOL,EAAUC,EAAe,GAAG,EAGrCuC,SAAUC,IACJ1C,IACFA,IACAA,OAAaqC,GAGfrC,EAAa2C,EAAQC,kBAAiB,EAAGC,kBACnCA,GACFH,GACF,GACA,EAGJI,MAAO5B,UACL,IACEF,EAAU,CAAA,QACJM,EAAayB,WAAWvC,SACxBc,EAAayB,WAAWtC,EAChC,CAAE,MAAOH,GAAO,GAEnB"}