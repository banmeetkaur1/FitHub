{"version":3,"file":"urql-storage-rn.js","sources":["../src/makeAsyncStorage.ts"],"sourcesContent":["import type { StorageAdapter } from '@urql/exchange-graphcache';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport NetInfo from '@react-native-community/netinfo';\n\nexport interface StorageOptions {\n  /** Name of the `AsyncStorage` key that’s used for persisted data.\n   * @defaultValue `'graphcache-data'`\n   */\n  dataKey?: string;\n  /** Name of the `AsyncStorage` key that’s used for persisted metadata.\n   * @defaultValue `'graphcache-metadata'`\n   */\n  metadataKey?: string;\n  /** Maximum age of cache entries (in days) after which data is discarded.\n   * @defaultValue `7` days\n   */\n  maxAge?: number;\n}\n\nconst parseData = (persistedData: any, fallback: any) => {\n  try {\n    if (persistedData) {\n      return JSON.parse(persistedData);\n    }\n  } catch (_err) {}\n\n  return fallback;\n};\n\nlet disconnect;\n\n/** React Native storage adapter persisting to `AsyncStorage`. */\nexport interface DefaultAsyncStorage extends StorageAdapter {\n  /** Clears the entire `AsyncStorage`. */\n  clear(): Promise<any>;\n}\n\n/** Creates a {@link StorageAdapter} which uses React Native’s `AsyncStorage`.\n *\n * @param opts - A {@link StorageOptions} configuration object.\n * @returns the created {@link DefaultAsyncStorage} adapter.\n *\n * @remarks\n * `makeAsyncStorage` creates a storage adapter for React Native,\n * which persisted to `AsyncStorage` via the `@react-native-async-storage/async-storage`\n * package.\n *\n * Note: We have no data on stability of this storage and our Offline Support\n * for large APIs or longterm use. Proceed with caution.\n */\nexport const makeAsyncStorage: (\n  ops?: StorageOptions\n) => DefaultAsyncStorage = ({\n  dataKey = 'graphcache-data',\n  metadataKey = 'graphcache-metadata',\n  maxAge = 7,\n} = {}) => {\n  const todayDayStamp = Math.floor(\n    new Date().valueOf() / (1000 * 60 * 60 * 24)\n  );\n  let allData = {};\n\n  return {\n    readData: async () => {\n      if (!Object.keys(allData).length) {\n        let persistedData: string | null = null;\n        try {\n          persistedData = await AsyncStorage.getItem(dataKey);\n        } catch (_err) {}\n        const parsed = parseData(persistedData, {});\n\n        Object.assign(allData, parsed);\n      }\n\n      // clean up old data\n      let syncNeeded = false;\n      Object.keys(allData).forEach(dayStamp => {\n        if (todayDayStamp - Number(dayStamp) > maxAge) {\n          syncNeeded = true;\n          delete allData[dayStamp];\n        }\n      });\n\n      if (syncNeeded) {\n        try {\n          await AsyncStorage.setItem(dataKey, JSON.stringify(allData));\n        } catch (_err) {}\n      }\n\n      return Object.assign(\n        {},\n        ...Object.keys(allData).map(key => allData[key])\n      );\n    },\n\n    writeData: async delta => {\n      if (!Object.keys(allData).length) {\n        let persistedData: string | null = null;\n        try {\n          persistedData = await AsyncStorage.getItem(dataKey);\n        } catch (_err) {}\n        const parsed = parseData(persistedData, {});\n        Object.assign(allData, parsed);\n      }\n\n      const deletedKeys = {};\n      Object.keys(delta).forEach(key => {\n        if (delta[key] === undefined) {\n          deletedKeys[key] = undefined;\n        }\n      });\n\n      for (const key in allData) {\n        allData[key] = Object.assign(allData[key], deletedKeys);\n      }\n\n      allData[todayDayStamp] = Object.assign(\n        allData[todayDayStamp] || {},\n        delta\n      );\n\n      try {\n        await AsyncStorage.setItem(dataKey, JSON.stringify(allData));\n      } catch (_err) {}\n    },\n\n    writeMetadata: async data => {\n      try {\n        await AsyncStorage.setItem(metadataKey, JSON.stringify(data));\n      } catch (_err) {}\n    },\n\n    readMetadata: async () => {\n      let persistedData: string | null = null;\n      try {\n        persistedData = await AsyncStorage.getItem(metadataKey);\n      } catch (_err) {}\n      return parseData(persistedData, []);\n    },\n\n    onOnline: cb => {\n      if (disconnect) {\n        disconnect();\n        disconnect = undefined;\n      }\n\n      disconnect = NetInfo.addEventListener(({ isConnected }) => {\n        if (isConnected) {\n          cb();\n        }\n      });\n    },\n\n    clear: async () => {\n      try {\n        allData = {};\n        await AsyncStorage.removeItem(dataKey);\n        await AsyncStorage.removeItem(metadataKey);\n      } catch (_err) {}\n    },\n  };\n};\n"],"names":["parseData","persistedData","fallback","JSON","parse","_err","disconnect","makeAsyncStorage","dataKey","metadataKey","maxAge","todayDayStamp","Math","floor","Date","valueOf","allData","readData","Object","keys","length","AsyncStorage","getItem","parsed","assign","syncNeeded","forEach","dayStamp","Number","setItem","stringify","map","key","writeData","delta","deletedKeys","undefined","writeMetadata","data","readMetadata","onOnline","cb","NetInfo","addEventListener","isConnected","clear","removeItem"],"mappings":"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"}